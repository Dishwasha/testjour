#!/usr/bin/env ruby

require File.expand_path("./vendor/plugins/cucumber/lib/cucumber")
require File.expand_path(File.dirname(__FILE__) + "/../lib/testjour")

Cucumber.disable_run

available_servers = Testjour::Jour.list

if available_servers.any?
  Testjour::QueueServer.with_server do |queue|    
    Testjour::QueueingExecutor.queue = queue
    
    silence_warnings { Cucumber::Executor = Testjour::QueueingExecutor }

    Testjour.logger.debug "Queueing features..."
    Cucumber::CLI.execute
    
    found_server = 0
    
    available_servers.each do |server|
      slave_server = DRbObject.new(nil, server.uri)
      result = slave_server.run(DRb.uri, File.expand_path("."))
      
      if result
        Testjour.logger.info "Requesting buld from available server: #{server.uri}. Accepted."
        found_server += 1
      else
        Testjour.logger.info "Requesting buld from available server: #{server.uri}. Rejected."
      end
    end
  
    if found_server > 0
      puts
      puts "#{found_server} slave accepted the build request. Waiting for results."
      puts
      
      $executor.wait_for_results
      Testjour.logger.debug "DONE"
    else
      puts
      puts "Found available servers, but none accepted the build request. Try again later."
    end
  end
else
  puts
  puts "Don't see any available test servers. Try again later."
end