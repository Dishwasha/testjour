#!/usr/bin/env ruby

require File.expand_path("./vendor/plugins/cucumber/lib/cucumber")
require File.expand_path(File.dirname(__FILE__) + "/../lib/testjour")

Cucumber.disable_run

available_servers = Testjour::Jour.list

if available_servers.any?
  Testjour::QueueServer.with_server do |queue|    
    Testjour::QueueingExecutor.queue = queue
    
    silence_warnings { Cucumber::Executor = Testjour::QueueingExecutor }

    Testjour.logger.info "Queueing features..."
    Cucumber::CLI.execute
    
    available_servers.each do |server|
      Testjour.logger.info "Requesting buld from available server: #{server.uri}"
      slave_server = DRbObject.new(nil, server.uri)
      slave_server.run(DRb.uri)
    end
  
    Testjour.logger.info "Waiting for results..."
    $executor.wait_for_results
    Testjour.logger.info "DONE"
  end
else
  puts "Don't see any available test servers. Try again later."
end